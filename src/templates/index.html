<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recommendation System</title>
</head>
<body>
    <h2>Recommendation System</h2>
    <form id="recommendationForm">
        <label for="product_choice">Select a Product:</label>
        <select id="product_choice" name="product_choice" required onchange="displayRelevantFeatures()">
            <option value="">--Choose a Product--</option>
            <option value="1">CD Account</option>
            <option value="2">Loan</option>
            <option value="3">Securities</option>
            <option value="4">Term Deposit</option>
        </select>
        <br><br>

        <div id="featureInputs"></div> <!-- Dynamic feature inputs will go here -->

        <button type="button" onclick="submitForm()">Get Recommendation</button>
    </form>

    <h3>Recommendation Result:</h3>
    <p id="result"></p>

    <script>
        let featureDescriptions = {};
        let productFeatures = {};

        // Predefined options for categorical fields
        const categoricalOptions = {
            "job": ["admin", "blue-collar", "entrepreneur", "housemaid", "management", "retired", "self-employed", "services", "student", "technician", "unemployed"],
            "marital": ["single", "married", "divorced"],
            "education": ["primary", "secondary", "tertiary", "unknown"],
            "default": ["yes", "no"],
            "contact": ["unknown", "telephone", "cellular"],
            "poutcome": ["unknown", "other", "failure", "success"]
        };

        // Fetch feature descriptions and product features on page load
        fetch('/feature_descriptions')
            .then(response => response.json())
            .then(data => { featureDescriptions = data; })
            .catch(error => console.error('Error fetching feature descriptions:', error));

        fetch('/product_features')
            .then(response => response.json())
            .then(data => { productFeatures = data; })
            .catch(error => console.error('Error fetching product features:', error));

        function displayRelevantFeatures() {
            const selectedProduct = document.getElementById('product_choice').value;
            const featureDiv = document.getElementById('featureInputs');
            featureDiv.innerHTML = '';

            const relevantFeatures = productFeatures[selectedProduct === "1" ? "cd_account" :
                                    selectedProduct === "2" ? "loan" :
                                    selectedProduct === "3" ? "securities" : "term_deposit"];

            relevantFeatures.forEach(feature => {
                if (featureDescriptions[feature]) {
                    const label = document.createElement('label');
                    label.innerHTML = `${feature}: ${featureDescriptions[feature]}<br>`;

                    // Check if the feature has predefined options (dropdown)
                    if (categoricalOptions[feature]) {
                        const select = document.createElement('select');
                        select.id = feature;
                        select.name = feature;

                        // Add options to the dropdown
                        categoricalOptions[feature].forEach(option => {
                            const optionElement = document.createElement('option');
                            optionElement.value = option;
                            optionElement.textContent = option.charAt(0).toUpperCase() + option.slice(1);  // Capitalize first letter
                            select.appendChild(optionElement);
                        });

                        featureDiv.appendChild(label);
                        featureDiv.appendChild(select);
                    } else {
                        // If no predefined options, create a text input
                        const input = document.createElement('input');
                        input.type = "text";
                        input.id = feature;
                        input.name = feature;

                        featureDiv.appendChild(label);
                        featureDiv.appendChild(input);
                    }

                    featureDiv.appendChild(document.createElement('br'));
                }
            });
        }

        function submitForm() {
            const formData = new FormData(document.getElementById('recommendationForm'));
            const data = Object.fromEntries(formData.entries());

            const payload = {
                product_choice: data.product_choice,
                user_data: data
            };

            fetch('/recommend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(result => {
                document.getElementById('result').textContent = `Recommendation: ${result.recommendation}`;
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>
